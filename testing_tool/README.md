# README

This folder contains main algorithm of our testing tool. While it could be called with CMD, we strongly recommended to use the IDE plugin version. The main algorithm misses a few features for user experiences.

This tool is built upon [PyExZ3](https://github.com/GroundPound/PyExZ3) and [CVC4](https://github.com/CVC4/CVC4).

## How to run

Please run 
```bash
export GOOGLE_APPLICATION_CREDENTIALS=path/to/your/credential.json # Google Cloud API related
export PYTHONPATH=/usr/local/share/pyshared/ # CVC4 related
```
to set up environment before execution.

There are two ways to launch our tool.
1. **[Strongly recommended]** Call with IDE plugin in `../ide_plugin`. Please check `../ide_plugin/README.md` for details.

2. Call with CMD tool. This version misses a few optimization for user experiences.

We provide an input example at `my_tool/cmd_example/`
```bash
cd my_tool
python3.8 all_wrap_up.py --input_json=cmd_example/input.json --output_json=cmd_example/output.json --log_file=cmd_example/log.txt
```
where `input_json` (would be auto-generated by IDE plugin) and `output_json` (would be visualized by IDE plugin) are the input and output of Keeper, respectively.  `log_file` is the file for logging.

`input_json` should be in format as:
```json
{
  "func_name": "is_jacket",
  "code_file": "cmd_example/check_jacket.py",
  "func_def_line": 4,
  "input_types": [
    "string"
  ],
  "API_param": [
    "image_path"
  ],
  "workspace": "cmd_example/"
}
```
- `func_name` is the name of the function to be tested. 
- `code_file` is the file that contains the definition of the tested function and all its callees.
- `func_def_line` is the line # of the head of function to be tested. It starts counting from 1.
- `input_types` is the type of input parameter, in the same order as function definition. It could be `"integer"`, `"float"` , `"boolean"`, or `"string"`.
- `API_param` is the input parameters that are ML API input. We currently only support a single API param.
- `workspace` is the working space of the tested function. 

## Configurations

Configurations are in `my_tool/global_vars.py`, including

- `TOTAL_LIMIT`: The maximum number of generated test cases
- `ACCURACY_THRESHOLD`: The threshold for low-accuracy failure. Only when over a threshold portion of inputs of a particular type have produced outputs that are inconsistent with common human judgement.
- `MAX_CANDIDATE`: The maximum number of suggested extra labels.
- `MAX_INPUT_EXAMPLE`: The maximum number of shown failed test cases


## The algorithm pipeline

`my_tool/all_wrap_up.py` contains following four steps:

1. Use `my_tool/code_extraction` folder to extract code from the original application.
2. Use `my_tool/change_code.py` to prepare constraint solving.
3. Use `my_tool/solve_multi.py` to generate test cases and launch tests.
4. Use `my_tool/label_suggestion.py`, `my_tool/emotion_suggestion.py`, and `my_tool/mutation_test.py` to provide fixing suggestion